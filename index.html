<!--
GLM-4.5 Mobile Chat — Single-file HTML + JS

How to use:
1. Paste this file into a new file called `index.html`.
2. Open it in your phone browser (or desktop) — it works locally.
3. First time: tap "Set API Key" and paste your OpenRouter API key. It is saved in your browser (localStorage).
4. Pick model (GLM-4.5 or GLM-4.5-Air) and start chatting.
5. To deploy: push to GitHub and enable Pages, or drag the file into Netlify Drop.

Notes:
- This UI stores your API Key only in your browser (localStorage) — it never leaves your device unless you share it.
- If OpenRouter changes their endpoint or required JSON, update the `API_ENDPOINT` variable below.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLM-4.5 Mobile Chat</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c3aed}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071029 0%, #071623 100%);font-family:Inter,ui-sans-serif,system-ui,Arial;color:#e6eef6}
    .app{max-width:760px;margin:0 auto;padding:16px;display:flex;flex-direction:column;height:100vh}
    header{display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;margin-left:auto;align-items:center}
    .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;margin-top:12px;flex:1;display:flex;flex-direction:column;overflow:hidden}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .msg{padding:10px;border-radius:10px;max-width:86%}
    .msg.user{align-self:flex-end;background:linear-gradient(90deg,#2b6df6,#6b8bff);color:white}
    .msg.bot{align-self:flex-start;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
    .inputRow{display:flex;gap:8px;margin-top:12px}
    input[type=text],textarea,select{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:8px;color:inherit;outline:none}
    textarea{resize:none;flex:1}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:white;font-weight:600}
    small{color:var(--muted)}
    .topRow{display:flex;gap:8px;align-items:center}
    .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
    .muted{color:var(--muted)}
    .footerNote{font-size:12px;color:var(--muted);margin-top:8px}
    @media (max-width:420px){.app{padding:10px}.card{padding:8px}.pill{font-size:12px}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>GLM‑4.5 Mobile Chat</h1>
        <small class="muted">Private — API key stays in your browser</small>
      </div>

      <div class="controls">
        <select id="modelSelect">
          <option value="z-ai/glm-4.5">GLM-4.5 (full)</option>
          <option value="z-ai/glm-4.5-air" selected>GLM-4.5-Air</option>
        </select>
        <div class="pill" id="keyStatus">No API key</div>
        <button id="setKeyBtn">Set API Key</button>
      </div>
    </header>

    <div class="card">
      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="inputRow">
        <textarea id="userInput" rows="2" placeholder="Type your message..."></textarea>
        <button id="sendBtn">Send</button>
      </div>

      <div class="topRow">
        <small class="muted">Model response options:</small>
        <label style="margin-left:10px"><input type="checkbox" id="streamToggle"> Stream (experimental)</label>
        <div style="flex:1"></div>
        <button id="clearBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 8px;border-radius:8px">Clear</button>
      </div>

      <div class="footerNote">Tip: Save this page to your home screen for an app-like experience.</div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    // If OpenRouter changes the API path, update this value.
    const API_ENDPOINT = 'https://api.openrouter.ai/v1/chat/completions';

    // === HELPERS ===
    const $ = id => document.getElementById(id);
    const messagesEl = $('messages');
    const apiKeyStorageKey = 'openrouter_api_key_glm';
    const modelStorageKey = 'openrouter_model_glm';

    function formatTime() {
      const d = new Date();
      return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    }

    function addMessage(text, who='bot'){
      const div = document.createElement('div');
      div.className = 'msg ' + (who==='user'? 'user':'bot');
      div.innerText = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setKeyUI(){
      const k = localStorage.getItem(apiKeyStorageKey);
      $('keyStatus').innerText = k ? 'API key set' : 'No API key';
    }

    // === INIT ===
    setKeyUI();
    const sel = $('modelSelect');
    sel.value = localStorage.getItem(modelStorageKey) || sel.value;

    // === UI actions ===
    $('setKeyBtn').addEventListener('click', ()=>{
      const current = localStorage.getItem(apiKeyStorageKey) || '';
      const key = prompt('Paste your OpenRouter API key here (it will be saved only in this browser):', current || '');
      if(key){
        localStorage.setItem(apiKeyStorageKey, key.trim());
        setKeyUI();
        alert('API key saved locally.');
      }
    });

    $('clearBtn').addEventListener('click', ()=>{
      if(confirm('Clear conversation?')){
        messagesEl.innerHTML = '';
      }
    });

    sel.addEventListener('change', ()=>{
      localStorage.setItem(modelStorageKey, sel.value);
    });

    $('sendBtn').addEventListener('click', sendMessage);
    $('userInput').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    async function sendMessage(){
      const text = $('userInput').value.trim();
      if(!text) return;
      const apiKey = localStorage.getItem(apiKeyStorageKey);
      if(!apiKey){ alert('Set your OpenRouter API key first.'); return; }

      const model = $('modelSelect').value;
      addMessage(text, 'user');
      $('userInput').value = '';

      addMessage('... thinking', 'bot');
      const botBubble = messagesEl.lastChild;

      try{
        const body = {
          model: model,
          messages: [{role: 'user', content: text}],
          max_tokens: 1024,
          temperature: 0.2
        };

        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify(body)
        });

        if(!res.ok){
          const errText = await res.text();
          botBubble.innerText = 'Error: ' + res.status + '\n' + errText;
          botBubble.style.whiteSpace = 'pre-wrap';
          return;
        }

        const data = await res.json();

        // Adjust to the response shape used by OpenRouter / model provider.
        // Common shapes:
        //  - { id, object, choices: [{message: {role, content}}] }
        //  - or { output: 'text' }

        let reply = '';
        if(data.choices && data.choices.length){
          // Chat-completions style
          const m = data.choices[0].message || data.choices[0].delta || data.choices[0].text;
          reply = (m && (m.content || m)) || JSON.stringify(data.choices[0]);
        } else if(data.output){
          reply = data.output;
        } else if(data.result){
          reply = data.result;
        } else {
          reply = JSON.stringify(data);
        }

        botBubble.innerText = reply;
        botBubble.style.color = '';
      }catch(err){
        botBubble.innerText = 'Error: ' + String(err);
      }
    }

    // Quick-save: allow exporting the conversation to a text file
    function exportConversation(){
      const lines = Array.from(messagesEl.children).map(n => n.innerText);
      const blob = new Blob([lines.join('\n\n')], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'glm-chat.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Add long-press or keyboard shortcut to export
    document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key==='e'){ exportConversation(); } });

  </script>
</body>
</html>
